#!/bin/bash
# Docker cleanup script
# Generated by Ansible

LOG_FILE="/var/log/docker-cleanup/cleanup-$(date +%Y%m%d).log"

echo "$(date): Starting Docker cleanup" >> "$LOG_FILE"

# Remove stopped containers
echo "$(date): Removing stopped containers" >> "$LOG_FILE"
docker container prune -f >> "$LOG_FILE" 2>&1

# Remove unused images
echo "$(date): Removing unused images" >> "$LOG_FILE"
docker image prune -f >> "$LOG_FILE" 2>&1

# Remove unused networks
echo "$(date): Removing unused networks" >> "$LOG_FILE"
docker network prune -f >> "$LOG_FILE" 2>&1

# Remove unused volumes
echo "$(date): Removing unused volumes" >> "$LOG_FILE"
docker volume prune -f >> "$LOG_FILE" 2>&1

# Remove build cache
echo "$(date): Removing build cache" >> "$LOG_FILE"
docker builder prune -f >> "$LOG_FILE" 2>&1

# Display disk usage after cleanup
echo "$(date): Docker disk usage after cleanup:" >> "$LOG_FILE"
docker system df >> "$LOG_FILE" 2>&1

echo "$(date): Docker cleanup completed" >> "$LOG_FILE"

# Keep only last 30 days of logs
find /var/log/docker-cleanup -name "cleanup-*.log" -type f -mtime +30 -delete